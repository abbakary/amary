{% extends 'tracker/base.html' %}


{% load static roles %}
{% block title %}Dashboard - Car Service Tracker{% endblock %}

{% block extra_css %}
<style>
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    transition: transform 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
  }
  .stats-card.orders { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .stats-card.customers { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
  .stats-card.active { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
  .stats-card.completed { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
  
  .chart-card {
    border-radius: 12px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .chart-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .welcome-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    margin-bottom: 2rem;
  }
  .activity-card {
    border-radius: 12px;
    border: 1px solid #e9ecef;
  }
  .status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .status-created { background: #e3f2fd; color: #1976d2; }
  .status-assigned { background: #fff3e0; color: #f57c00; }
  .status-in_progress { background: #e8f5e8; color: #388e3c; }
  .status-completed { background: #e8f5e8; color: #2e7d32; }
  .status-cancelled { background: #ffebee; color: #d32f2f; }
  
  .priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
  }
  .priority-low { background: #e3f2fd; color: #1976d2; }
  .priority-normal { background: #e8f5e8; color: #388e3c; }
  .priority-high { background: #fff3e0; color: #f57c00; }
  .priority-urgent { background: #ffebee; color: #d32f2f; }
  
  .table-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }
  .inventory-item {
    border-left: 4px solid var(--bs-primary);
    background: #f8f9fa;
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    border-radius: 0 6px 6px 0;
  }
  .low-stock {
    border-left-color: #dc3545;
  }
  .out-stock {
    border-left-color: #6c757d;
    opacity: 0.7;
  }
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
    color: #495057;
  }
  .action-btn:hover {
    border-color: var(--bs-primary);
    color: var(--bs-primary);
    transform: translateY(-2px);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Welcome Section -->
  <div class="welcome-card card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h4 class="mb-2">Welcome back, {{ request.user.first_name|default:request.user.username }}!</h4>
          <p class="mb-0 opacity-75">Here's what's happening with your car service business today.</p>
        </div>
        <div class="text-end">
          <div class="small opacity-75">{{ "now"|date:"F j, Y" }}</div>
          <div class="small opacity-75">{{ "now"|date:"l, g:i A" }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <a href="{% url 'tracker:customer_register' %}" class="action-btn">
      <i data-feather="user-plus" class="feather-20"></i>
      <span>Register New Customer</span>
    </a>
    <a href="{% url 'tracker:order_start' %}" class="action-btn">
      <i data-feather="plus-circle" class="feather-20"></i>
      <span>Create New Order</span>
    </a>
    <a href="{% url 'tracker:customers_list' %}" class="action-btn">
      <i data-feather="users" class="feather-20"></i>
      <span>View All Customers</span>
    </a>
    <a href="{% url 'tracker:orders_list' %}" class="action-btn">
      <i data-feather="list" class="feather-20"></i>
      <span>View All Orders</span>
    </a>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card orders">
        <div class="card-body text-center">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-0 opacity-75">Total Orders</h6>
              <h2 class="mb-0">{{ total_orders|default:0 }}</h2>
            </div>
            <i data-feather="shopping-cart" class="feather-24 opacity-75"></i>
          </div>
          <small class="opacity-75">All time orders</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card customers">
        <div class="card-body text-center">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-0 opacity-75">Total Customers</h6>
              <h2 class="mb-0">{{ total_customers|default:0 }}</h2>
            </div>
            <i data-feather="users" class="feather-24 opacity-75"></i>
          </div>
          <small class="opacity-75">Registered customers</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card active">
        <div class="card-body text-center">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-0 opacity-75">Active Orders</h6>
              <h2 class="mb-0">{{ active_count|default:0 }}</h2>
            </div>
            <i data-feather="activity" class="feather-24 opacity-75"></i>
          </div>
          <small class="opacity-75">Currently in progress</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card completed">
        <div class="card-body text-center">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-0 opacity-75">Completed Today</h6>
              <h2 class="mb-0">{{ completed_today_count|default:0 }}</h2>
            </div>
            <i data-feather="check-circle" class="feather-24 opacity-75"></i>
          </div>
          <small class="opacity-75">Orders finished today</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card chart-card h-100">
        <div class="card-header">
          <h6 class="mb-0">
            <i data-feather="pie-chart" class="me-2 feather-16"></i>Orders by Status
          </h6>
        </div>
        <div class="card-body">
          <div id="statusChart" style="min-height: 200px;"></div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card chart-card h-100">
        <div class="card-header">
          <h6 class="mb-0">
            <i data-feather="bar-chart" class="me-2 feather-16"></i>Orders by Type
          </h6>
        </div>
        <div class="card-body">
          <div id="typeChart" style="min-height: 200px;"></div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card chart-card h-100">
        <div class="card-header">
          <h6 class="mb-0">
            <i data-feather="target" class="me-2 feather-16"></i>By Priority
          </h6>
        </div>
        <div class="card-body">
          <div id="priorityChart" style="min-height: 200px;"></div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card chart-card h-100">
        <div class="card-header">
          <h6 class="mb-0">
            <i data-feather="trending-up" class="me-2 feather-16"></i>14-Day Trend
          </h6>
        </div>
        <div class="card-body">
          <div id="trendChart" style="min-height: 200px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row g-4">
    <!-- Recent Orders -->
    <div class="col-lg-8">
      <div class="card activity-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i data-feather="clock" class="me-2 feather-18"></i>Recent Orders
          </h5>
          <div class="d-flex gap-2">
            <a href="{% url 'tracker:orders_list' %}" class="btn btn-sm btn-outline-primary">
              <i data-feather="external-link" class="me-1"></i>View All
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          {% if recent_orders %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-3">Order</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Vehicle</th>
                    <th class="pe-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in recent_orders %}
                    <tr>
                      <td class="ps-3">
                        <a href="{% url 'tracker:order_detail' o.id %}" class="fw-semibold text-decoration-none">
                          {{ o.order_number }}
                        </a>
                        <br><small class="text-muted">{{ o.created_at|date:"M d, H:i" }}</small>
                      </td>
                      <td>
                        <a href="{% url 'tracker:customer_detail' o.customer.id %}" class="text-decoration-none">
                          {{ o.customer.full_name }}
                        </a>
                        <br><small class="text-muted">{{ o.customer.phone }}</small>
                      </td>
                      <td>
                        <span class="badge bg-light text-dark">{{ o.get_type_display }}</span>
                      </td>
                      <td>
                        <span class="status-badge status-{{ o.status }}">{{ o.get_status_display }}</span>
                      </td>
                      <td>
                        <span class="priority-badge priority-{{ o.priority }}">{{ o.get_priority_display }}</span>
                      </td>
                      <td>
                        {% if o.vehicle %}
                          <strong>{{ o.vehicle.plate_number }}</strong>
                          <br><small class="text-muted">{{ o.vehicle.make }} {{ o.vehicle.model }}</small>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td class="pe-3">
                        <div class="table-actions">
                          <form method="post" action="{% url 'tracker:update_order_status' o.id %}" class="d-inline">
                            {% csrf_token %}
                            <div class="input-group input-group-sm">
                              <select name="status" class="form-select" style="max-width: 120px;">
                                {% for k,v in o.STATUS_CHOICES %}
                                  <option value="{{ k }}" {% if o.status == k %}selected{% endif %}>{{ v }}</option>
                                {% endfor %}
                              </select>
                              <button class="btn btn-outline-primary btn-sm" type="submit">
                                <i data-feather="check" class="feather-12"></i>
                              </button>
                            </div>
                          </form>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i data-feather="inbox" class="feather-48 text-muted mb-3"></i>
              <h6 class="text-muted">No Recent Orders</h6>
              <p class="text-muted mb-3">Start by creating your first order</p>
              <a href="{% url 'tracker:order_start' %}" class="btn btn-primary">
                <i data-feather="plus" class="me-1"></i>Create Order
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Inventory & System Info -->
    <div class="col-lg-4">
      <!-- Inventory Preview -->
      <div class="card activity-card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i data-feather="package" class="me-2 feather-16"></i>Inventory Status
          </h6>
          {% if can_manage_inventory %}
            <a href="{% url 'tracker:inventory_list' %}" class="btn btn-sm btn-outline-primary">
              <i data-feather="settings" class="me-1"></i>Manage
            </a>
          {% endif %}
        </div>
        <div class="card-body">
          {% if inventory_preview %}
            {% for i in inventory_preview %}
              <div class="inventory-item {% if i.quantity <= 5 %}low-stock{% endif %}{% if i.quantity == 0 %}out-stock{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong class="d-block">{{ i.name }}</strong>
                    {% if i.brand %}<small class="text-muted">{{ i.brand }}</small>{% endif %}
                  </div>
                  <div class="text-end">
                    <strong class="d-block {% if i.quantity <= 5 %}text-warning{% endif %}{% if i.quantity == 0 %}text-danger{% endif %}">
                      {{ i.quantity }}
                    </strong>
                    <small class="text-muted">units</small>
                  </div>
                </div>
              </div>
            {% endfor %}
            <hr>
            <div class="text-center">
              <strong>Total Stock: {{ total_stock|default:0 }}</strong>
            </div>
          {% else %}
            <div class="text-center py-3">
              <i data-feather="package" class="feather-32 text-muted mb-2"></i>
              <p class="text-muted mb-2">No inventory items</p>
              {% if can_manage_inventory %}
                <a href="{% url 'tracker:inventory_create' %}" class="btn btn-sm btn-outline-primary">
                  <i data-feather="plus" class="me-1"></i>Add Items
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- System Information -->
      <div class="card activity-card">
        <div class="card-header">
          <h6 class="mb-0">
            <i data-feather="info" class="me-2 feather-16"></i>System Information
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-2 text-center">
            <div class="col-6">
              <div class="border rounded p-2">
                <div class="text-muted small">Database</div>
                <strong class="text-success">Connected</strong>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-2">
                <div class="text-muted small">Version</div>
                <strong>v1.0.0</strong>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-2">
                <div class="text-muted small">Users</div>
                <strong>{{ user_count|default:1 }}</strong>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-2">
                <div class="text-muted small">Role</div>
                <strong class="text-primary">
                  {% if request.user.is_superuser %}Admin{% elif request.user|has_group:'manager' %}Manager{% else %}User{% endif %}
                </strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/animation/wow/wow.min.js' %}"></script>
<script src="{% static 'js/notify/bootstrap-notify.min.js' %}"></script>
<script id="chartsdata" type="application/json">{{ charts_json|safe }}</script>
<script>
(function(){
  'use strict';
  
  // Initialize animations
  if (window.WOW) new WOW().init();
  
  // Welcome notification
  setTimeout(() => {
    try {
      if ($.notify) {
        $.notify({
          message: 'Welcome back, {{ request.user.first_name|default:request.user.username }}! 🎉',
          icon: 'fa fa-bell'
        }, {
          type: 'info',
          delay: 4000,
          placement: {
            from: 'top',
            align: 'right'
          },
          animate: {
            enter: 'animated fadeInDown',
            exit: 'animated fadeOutUp'
          }
        });
      }
    } catch(e) {
      console.warn('Notification error:', e);
    }
  }, 1000);

  // Initialize charts
  const dataEl = document.getElementById('chartsdata');
  if (!dataEl || !window.ApexCharts) return;
  
  try {
    const data = JSON.parse(dataEl.textContent || '{}');
    
    // Chart configuration function
    const createDonutChart = (selector, labels, series, colors) => ({
      chart: {
        type: 'donut',
        height: 200,
        fontFamily: 'inherit'
      },
      labels: labels,
      series: series,
      colors: colors || ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
      legend: {
        position: 'bottom',
        fontSize: '12px',
        fontFamily: 'inherit'
      },
      dataLabels: {
        enabled: true,
        formatter: function(val) {
          return Math.round(val) + '%';
        }
      },
      plotOptions: {
        pie: {
          donut: {
            size: '60%'
          }
        }
      },
      stroke: {
        width: 0
      },
      responsive: [{
        breakpoint: 768,
        options: {
          chart: {
            height: 180
          },
          legend: {
            fontSize: '10px'
          }
        }
      }]
    });

    // Status chart
    if (data.status && document.querySelector('#statusChart')) {
      new ApexCharts(
        document.querySelector('#statusChart'),
        createDonutChart('#statusChart', data.status.labels, data.status.values, 
          ['#17a2b8', '#ffc107', '#28a745', '#007bff', '#dc3545'])
      ).render();
    }

    // Type chart
    if (data.type && document.querySelector('#typeChart')) {
      new ApexCharts(
        document.querySelector('#typeChart'),
        createDonutChart('#typeChart', data.type.labels, data.type.values,
          ['#28a745', '#fd7e14', '#6f42c1'])
      ).render();
    }

    // Priority chart
    if (data.priority && document.querySelector('#priorityChart')) {
      new ApexCharts(
        document.querySelector('#priorityChart'),
        createDonutChart('#priorityChart', data.priority.labels, data.priority.values,
          ['#17a2b8', '#28a745', '#ffc107', '#dc3545'])
      ).render();
    }

    // Trend chart
    if (data.trend && document.querySelector('#trendChart')) {
      new ApexCharts(document.querySelector('#trendChart'), {
        chart: {
          type: 'area',
          height: 200,
          fontFamily: 'inherit',
          toolbar: { show: false },
          sparkline: { enabled: false }
        },
        series: [{
          name: 'Orders',
          data: data.trend.values || []
        }],
        xaxis: {
          categories: data.trend.labels || [],
          labels: {
            rotate: -45,
            style: {
              fontSize: '10px'
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              fontSize: '10px'
            }
          }
        },
        dataLabels: { enabled: false },
        stroke: {
          curve: 'smooth',
          width: 2
        },
        fill: {
          type: 'gradient',
          gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.4,
            opacityTo: 0.1
          }
        },
        colors: ['#667eea'],
        grid: {
          borderColor: '#f1f1f1',
          strokeDashArray: 4
        }
      }).render();
    }

  } catch(e) {
    console.warn('Charts initialization error:', e);
  }

  // Initialize feather icons
  if (window.feather) {
    feather.replace();
  }

  // Auto-refresh functionality (optional)
  setInterval(() => {
    // Update time display
    const now = new Date();
    const timeElements = document.querySelectorAll('.current-time');
    timeElements.forEach(el => {
      el.textContent = now.toLocaleTimeString();
    });
  }, 60000); // Update every minute

})();
</script>
{% endblock %}
